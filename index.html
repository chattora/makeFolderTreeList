<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* ボタンが無効なときのスタイル */
    .disabled-button {
      background-color: #d3d3d3; /* グレーの背景色 */
      color: #a9a9a9; /* グレーの文字色 */
      cursor: not-allowed; /* 無効化カーソル */
    }
  </style>
</head>

<body>
  <form onsubmit="event.preventDefault(); submitForm();">
    <label for="inputId">ドライブのIDもしくはフォルダのIDを入力してください:</label>
    <input type="text" id="inputId" required>
    <br><br>

    <label>出力モードを選択してください→:</label>
    <br>
    <input type="radio" id="radio1" name="radioGroup" value="mode1" required>
    <label for="radio1">フォルダのみの階層（ファイル数が多いと予想される場合はこちら）</label><br>
    <input type="radio" id="radio2" name="radioGroup" value="mode2">
    <label for="radio2">ファイルも含めた階層</label><br>
    <br>

    <input type="submit" id="submitButton" value="実行"> <!-- IDを追加 -->
  </form>

  <h3>▼StatusMessageを表示:</h3>
  <div id="textBox">ここにメッセージがでます</div>

  <script>
    var formSubmitted = false; // フォーム連打を防ぐためのフラグ
    var pollingActive = true;

    function submitForm() {
      var submitButton = document.getElementById('submitButton');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.classList.add('disabled-button');
      }

      if (formSubmitted) {
        console.log("すでに押されている");
        return;
      }
      console.log("最初の押された");
      formSubmitted = true;

      var formData = {
        inputId: document.getElementById('inputId').value,
        mode: document.querySelector('input[name="radioGroup"]:checked').value
      };
      google.script.run
        .withSuccessHandler(function(response) {
          console.log("サーバーからの応答:" + response); // <----- ここ変更した
          document.getElementById('textBox').innerText = response;
          //フォームからの値をもってmainを実行
          google.script.run._main(response);

        })
        .withFailureHandler(function(error) {
          console.error('GAS関数呼び出し中にエラーが発生しました:', error);
          document.getElementById('textBox').innerText = 'エラーが発生しました: ' + error.message;
        })
        ._setForm(formData);
    }

    var pollingActive = true;

    async function _putMess() {
      while (pollingActive) {
        try {
          const result = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              ._getPutMess();
          });

          console.log("取得した結果:", result);

          if (result) {
            document.getElementById('textBox').innerText = result;

            // 特定の文字列が含まれているかチェック
            if (result.includes("完了") || result.includes("終了")) {
              console.log("処理が完了しました。ポーリングを停止します。");
              pollingActive = false;
              break; // whileループを抜けてポーリングを停止
            }
          }
          // 次のポーリングまでの待機時間
          await new Promise(resolve => setTimeout(resolve, 1000)); // 1秒待機

        } catch (error) {
          console.error('エラーが発生しました:', error);
        }
      }

      if (!pollingActive) {
        _displayCompletionMessage(); // ポーリング停止後に終了メッセージを表示
      }
    }

    function _putStartMess() {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("初期メッセージ:" + result); 
          document.getElementById('textBox').innerText = result;
        })
        ._setPutMess("フォルダIDの代入とmodeの選択をしてください");
    }

    function _displayCompletionMessage() {
      document.getElementById('textBox').innerText = "設定が完了しました。メールを確認したら、ブラウザを閉じてください。"; // メッセージを表示
    }
    window.onload = function() {
      _putStartMess();
      _putMess(); // ページが読み込まれたときにポーリング開始
    }
  </script>
</body>
</html>
